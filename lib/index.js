"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports["default"]=void 0;var _react=_interopRequireWildcard(require("react"));var _propTypes=_interopRequireDefault(require("prop-types"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj};}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):{};if(desc.get||desc.set){Object.defineProperty(newObj,key,desc);}else{newObj[key]=obj[key];}}}}newObj["default"]=obj;return newObj;}}function _typeof(obj){if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj;};}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};}return _typeof(obj);}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor;}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call;}return _assertThisInitialized(self);}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o);};return _getPrototypeOf(o);}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function");}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});if(superClass)_setPrototypeOf(subClass,superClass);}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o;};return _setPrototypeOf(o,p);}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}/**
 *
 * @param children
 * @param version
 * @param getLatestVersion
 * @param checkVersion {Function} In you need an special validation pass a function that returns boolean.
 * @param renderHotUpdate {Function} When the system detects an update the component will render the result of executing this function passing the children as first argument.
 * @param debug
 * @param enabled
 * @returns {*}
 * @constructor
 */var VersionControl=/*#__PURE__*/function(_Component){_inherits(VersionControl,_Component);function VersionControl(props){var _this;_classCallCheck(this,VersionControl);_this=_possibleConstructorReturn(this,_getPrototypeOf(VersionControl).call(this,props));_defineProperty(_assertThisInitialized(_this),"handleCheckUpdate",function(force){if(force){_this.timeoutCallback();}if(_this.updateDaemon){clearTimeout(_this.updateDaemon);}var time=30*60*1000;_this.updateDaemon=setTimeout(_this.timeoutCallback,time);});_defineProperty(_assertThisInitialized(_this),"timeoutCallback",function(){var version=_this.state.version;var _this$props=_this.props,getLatestVersion=_this$props.getLatestVersion,checkVersion=_this$props.checkVersion;var lastVersion=getLatestVersion();var updated=true;if(checkVersion&&typeof checkVersion==='function'){updated=checkVersion(version,lastVersion);if(typeof updated!=='boolean'){var error=new Error("Function checkVersion should return boolean but returned ".concat(_typeof(updated)));throw error.stack;}}else{updated=version===lastVersion;}if(!updated){if(debug){console.table({oldVersion:version,newVersion:lastVersion,message:'New version detected when the app it\'s already mounted.'});}_this.setState(function(state){state.hotUpdate=true;return state;});}});_defineProperty(_assertThisInitialized(_this),"manageUpdate",function(){window.location.reload(true);});_defineProperty(_assertThisInitialized(_this),"setDevelopmentEnhancers",function(){console.info('--------------------------------');console.info('Setting up development enhancers');try{window.setHotUpdate=function(){_this.setState({hotUpdate:!_this.state.hotUpdate});};window.setLoadUpdate=function(){_this.setState({onLoad:!_this.state.onLoad});};console.info('Enhancers are ready, now you can use this methods to update the state, for more info look at the documentation: https://gitlab.com/oscmedgon/versioncontrol/blob/master/README.md');console.table({'window.setHotUpdate':'Set the hot update to true to force show the notification','window.setLoadUpdate':'Set the onLoad, the version control will automatically update the page'});}catch(error){console.error('Error setting up development enhancers, this doesn\'t affects to the component standard behaviour, but you can report the error.');console.error(error.stack);}});var _version=props.version,_props$debug=props.debug,_debug=_props$debug===void 0?true:_props$debug,_props$enabled=props.enabled,enabled=_props$enabled===void 0?true:_props$enabled,_props$getLatestVersi=props.getLatestVersion,_getLatestVersion=_props$getLatestVersi===void 0?Function:_props$getLatestVersi,_checkVersion=props.checkVersion;var _state={version:_version,debug:_debug,enabled:enabled,onLoad:false,hotUpdate:false,disabled:false};if(enabled){var lastVersion=_getLatestVersion();var updated=true;if(_checkVersion&&typeof _checkVersion==='function'){updated=_checkVersion(_version,lastVersion);if(typeof updated!=='boolean'){var error=new Error("Function checkVersion should return boolean but returned ".concat(_typeof(updated)));throw error.stack;}}else{updated=_version===lastVersion;}if(!updated){if(_debug){console.table({oldVersion:_version,newVersion:lastVersion,message:'New version detected at the first load proceeding to reload the page.'});}_state.onLoad=true;}}if(_debug){_this.setDevelopmentEnhancers();}_this.state=_state;return _this;}_createClass(VersionControl,[{key:"componentDidMount",value:function componentDidMount(){this.handleCheckUpdate();}},{key:"componentWillReceiveProps",value:function componentWillReceiveProps(_ref){var debug=_ref.debug,enabled=_ref.enabled,version=_ref.version;if(debug!==this.props.debug){this.setState(function(state){state.debug=debug;return state;});}if(enabled!==this.props.enabled){this.setState(function(state){state.enabled=enabled;return state;});}if(version!==this.props.version){this.setState(function(state){state.version=version;return state;});}}},{key:"componentWillUnmount",value:function componentWillUnmount(){if(this.updateDaemon){clearTimeout(this.updateDaemon);}}},{key:"render",value:function render(){var _this$state=this.state,hotUpdate=_this$state.hotUpdate,enabled=_this$state.enabled,onLoad=_this$state.onLoad;var _this$props2=this.props,children=_this$props2.children,renderHotUpdate=_this$props2.renderHotUpdate;if(!enabled){return children;}else{if(onLoad){this.manageUpdate();}else if(hotUpdate){return _react["default"].createElement(_react["default"].Fragment,null,children,renderHotUpdate(this.manageUpdate));}else{return children;}}}}]);return VersionControl;}(_react.Component);exports["default"]=VersionControl;_defineProperty(VersionControl,"propTypes",{children:_propTypes["default"].node.isRequired,version:_propTypes["default"].string.isRequired,getLatestVersion:_propTypes["default"].func.isRequired,checkVersion:_propTypes["default"].func,renderHotUpdate:_propTypes["default"].func.isRequired,debug:_propTypes["default"].bool,enabled:_propTypes["default"].bool});_defineProperty(VersionControl,"defaultProps",{version:'version',getLatestVersion:function getLatestVersion(){return'version';},renderHotUpdate:function renderHotUpdate(children){return _react["default"].createElement("div",{className:"version-control"},children,_react["default"].createElement("h1",null,"Update available"));}});